{% extends 'base.html' %}
{% block content %}
<h2 class="mb-3">Upload Apple Health XML</h2>
<form id="upload-form" action="/upload" method="post" enctype="multipart/form-data" class="mb-4 p-3 bg-white rounded shadow-sm">
  <div class="mb-3">
    <input type="file" name="file" class="form-control" required>
  </div>
  <button type="submit" class="btn btn-primary">Upload</button>
  <div id="progress-container" class="mt-2" style="display:none">
    <div class="progress">
      <div id="upload-progress" class="progress-bar" role="progressbar" style="width:0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
    <small id="time-remaining" class="text-muted"></small>
  </div>
</form>

<h2 class="mb-3">Create Habit</h2>
<form action="/habits" method="post" id="habit-form" class="mb-4 p-3 bg-white rounded shadow-sm">
  <div class="mb-3">
    <label class="form-label">Name</label>
    <input type="text" name="name" class="form-control" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Input Type</label>
    <select name="input_type" class="form-select">
      <option value="boolean">Yes/No</option>
      <option value="number">Number</option>
      <option value="scale3">Low/Medium/High</option>
      <option value="scale5">1 to 5</option>
    </select>
  </div>
  <button type="submit" class="btn btn-success">Create</button>
</form>

{% if habits %}
<h2>Today&#39;s Habits</h2>
{% for h in habits %}
  <form action="/habit_entries" method="post" class="mb-2">
    <input type="hidden" name="habit_id" value="{{ h[0] }}">
    <input type="hidden" name="entry_date" value="{{ today }}">
    <strong>{{ h[1] }}</strong>
    {% if h[2] == 'boolean' %}
      <button name="value" value="1" class="btn btn-sm btn-outline-primary">Yes</button>
      <button name="value" value="0" class="btn btn-sm btn-outline-secondary">No</button>
    {% elif h[2] == 'number' %}
      <input type="number" name="value" step="any" class="form-control d-inline-block w-auto">
      <button type="submit" class="btn btn-sm btn-primary">Save</button>
    {% elif h[2] == 'scale3' %}
      <button name="value" value="low" class="btn btn-sm btn-outline-secondary">Low</button>
      <button name="value" value="medium" class="btn btn-sm btn-outline-secondary">Medium</button>
      <button name="value" value="high" class="btn btn-sm btn-outline-secondary">High</button>
    {% elif h[2] == 'scale5' %}
      {% for i in range(1,6) %}
        <button name="value" value="{{ i }}" class="btn btn-sm btn-outline-secondary">{{ i }}</button>
      {% endfor %}
    {% endif %}
  </form>
{% endfor %}
{% endif %}

<p><a href="/analytics">View Analytics</a> (use <code>?accuracy=high|medium|low</code>)</p>
{% if metrics %}
<h3>Metrics found in last upload:</h3>
<ul>
  {% for m in metrics %}
  <li>{{ m }}</li>
  {% endfor %}
</ul>
{% endif %}
<script>
  document.getElementById('upload-form').addEventListener('submit', function (e) {
    e.preventDefault();
    const form = e.target;
    const data = new FormData(form);
    const xhr = new XMLHttpRequest();
    const progressBar = document.getElementById('upload-progress');
    const container = document.getElementById('progress-container');
    const timeRemaining = document.getElementById('time-remaining');
    container.style.display = 'block';
    const start = Date.now();
    xhr.upload.addEventListener('progress', function (event) {
      if (event.lengthComputable) {
        const percent = Math.round(event.loaded / event.total * 100);
        progressBar.style.width = percent + '%';
        progressBar.setAttribute('aria-valuenow', percent);
        progressBar.textContent = percent + '%';
        const elapsed = (Date.now() - start) / 1000;
        const estimatedTotal = elapsed / (event.loaded / event.total);
        const remaining = Math.max(estimatedTotal - elapsed, 0);
        timeRemaining.textContent = 'Осталось примерно ' + Math.round(remaining) + ' сек.';
      }
    });
    xhr.onload = function () {
      if (xhr.status >= 200 && xhr.status < 300) {
        document.open();
        document.write(xhr.responseText);
        document.close();
      } else {
        alert('Ошибка загрузки');
      }
    };
    xhr.open('POST', form.action);
    xhr.send(data);
  });
</script>
{% endblock %}

